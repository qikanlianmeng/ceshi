<?php
$this->qc_template_mobile('header');
?>
<style>
    body{
        background-color: {$conf['bg_color']}
    }
    .pin{
        margin:10px;
        border-radius:5px;
        border:1px #EFEFEF solid;
        background-color: white;
        padding: 10px 10px 0px 10px;
    }
    .address{
        margin:10px 15px;
        font-size:80%;
    }
    .item {
        margin:0px 10px;
        border:1px #E0E0E0 solid;
        padding:8px 5px;
        font-size:12px;
    }
    .item_border_top_0 {
        border-top:0px;
    }
    .item_content {
        height:20px;
    }
    .item_1 {
        color: grey;
        border-right:1px #E0E0E0 solid;
        width:60px;
        line-height: 20px
    }
    .item_2_0 {
        position: relative;
        top:-20px;
        margin-left:60px;
        margin-right:40px;
    }
    .item_2_1 {
        position: relative;
        top:-20px;
        margin-left:60px;
    }
    .item_2_2 {
        position: relative;
        top:-20px;
        margin-left:60px;
        margin-right:70px;
    }
    .item_3_0 {
        position: relative;
        top:-40px;
        margin:0px 0px 0px auto;
        width:40px;
        text-align: right;
        margin-right:10px;
        line-height: 20px
    }
    .item_3_1 {
        position: relative;
        top:-40px;
        margin:0px 0px 0px auto;
        width:70px;
        line-height: 20px;
        border-left:1px #E0E0E0 solid;
        padding-left:5px;
    }
    a:hover {
        text-decoration: none
    }
</style>
<script>
    mui('body').on('tap','a',function(){document.location.href=this.href;});  
</script>
<div id="step_1">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-icon mui-icon-person mui-pull-left mui-plus-visble" href="javascript:person()"></a>
        <a class="mui-pull-right" style="font-size:14px;height:44px;line-height: 44px" href="{php echo $this->createMobileurl('index')}"><img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/user_center_icon2.png" height="20px" width="auto" />&nbsp;乘客</a>
        <h1 class="mui-title" style="font-weight: normal"><span class="mui-icon mui-icon-location" style="font-size:16px"></span><span onclick="change_city()">{php echo $this->rtrim_cn($_SESSION['city'],'市');}&nbsp;<i class="fa fa-angle-down"></i></span></h1>
    </header>
    <script>
    var mask = mui.createMask(function(){
        $("#travel_release_panel").show();
        $("#person_panel").hide();
    });//callback为用户点击蒙版时自动执行的回调；;
    function person() {
        $("#travel_release_panel").hide();
        mask.show();
        $("#person_panel").show();
    }
    </script>
    <div id="person_panel" style="position: fixed;width:60%;top:0px;height:100%;background-color: white;z-index: 999;display:none">
        <div style="margin-top:40px;text-align: center">
            <img src="{$_W['fans']['headimgurl']}" width="50px" height="50px" style="border-radius: 40px;border:2px white solid" />
        </div>
        <div style="text-align: center">
            {$_W['fans']['nickname']}
        </div>
        {if $conf['member_on'] == '1' && $member_info['level_id'] > 0}
            <div style="text-align: center;font-size:12px;color:grey" onclick="location.href='{php echo murl('entry', array('m' => 'navlange_member', 'do' => 'index'), true, true);}'">
                {$member_info['level']}
            </div>
        {/if}
        <div style="margin-top:40px">
            <div style="height:40px;margin-left:30px" onclick="location.href='{php echo $this->createMobileurl('owner_pin');}'">
                <div style="width:40px;height:40px;text-align: center;padding-top:9px">
                    <img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/travel.png" height="20px" width="auto" />
                </div>
                <div style="margin:-40px 0px 0px 40px;height:40px;line-height: 40px">
                    出车
                </div>
            </div>
            <div style="height:40px;margin-top:20px;margin-left:30px" onclick="location.href='{php echo $this->createMobileurl('owner');}'">
                <div style="width:40px;height:40px;text-align: center;padding-top:9px">
                    <img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/person_profile.png" height="20px" width="auto" />
                </div>
                <div style="margin:-40px 0px 0px 40px;height:40px;line-height: 40px">
                    司机中心
                </div>
            </div>
        </div>
    </div>
    <div style="height:44px"></div>
    {if $conf['pin_release_advertise_on']=='1'}
    <link rel="stylesheet" href="./resource/components/swiper/swiper.min.css">
    <div class="mui-slider">
        <div class="mui-slider-group mui-slider-loop">
            <div class="mui-slider-item">
                <a href="javascript:page_view('{php echo $advertise_info[count($advertise_info)-1]['url']}',{php echo $advertise_info[count($advertise_info)-1]['advertise_id']})"><img width="100%" height="auto" src="{php echo  tomedia($advertise_info[count($advertise_info)-1]['pic_name'])}" /></a>
            </div>
            {loop $advertise_info $index $item}
            <div class="mui-slider-item">
                <a href="javascript:page_view('{$item['url']}',{$item['advertise_id']})"><img width="100%" height="auto" src="{php echo tomedia($item['pic_name'])}" /></a>
            </div>
            {/loop}
            <div class="mui-slider-item">
                <a href="javascript:page_view('{$advertise_info[0]['url']}',{$advertise_info[0]['advertise_id']})"><img width="100%" height="auto" src="{php echo tomedia($advertise_info[0]['pic_name'])}" /></a>
            </div>
        </div>
        <div class="mui-slider-indicator">   
            {loop $advertise_info $index $item}
                <div class="mui-indicator {if $index==0}mui-active{/if}"></div> 
            {/loop}
        </div>  
    </div>
    <div style="background-color: white">
        {loop $url $index $item}
        <div style="width:33.33%;float:left;padding-top:8px;padding-bottom:8px" onclick="location.href='{$item['url']}'">
            <div style="text-align: center">
                <img src="{php echo tomedia($item['img'])}" width="30px" height="30px" />
            </div>
            <div style="text-align: center">
                {$item['name']}
            </div>
        </div>
        {/loop}
        <div style="clear:both"></div>
    </div>
    <script>
    var gallery = mui('.mui-slider');
    gallery.slider({
        interval:5000//自动轮播周期，若为0则不自动播放，默认为0；
    });

    function page_view(url,adv_id) {
        $.post("{php echo $_W['siteroot'] . 'app/index.php?i=' . $_W['uniacid'] . '&c=entry&do=view&m=navlange_advertise';}",{
                advertise_id:adv_id,
                module_id:{$_W['current_module']['mid']}
            },
            function(resp) {
                resp = $.parseJSON(resp);
                var res = resp.message;
                if(res.errno == 0) {
                    window.location.href=url;
                }
            }
        );
    }
    </script>
    {/if}
    {if $conf['mode_menu_on'] == '1'}
    <style>
    .mui-segmented-control.mui-segmented-control-inverted .mui-control-item {
        border-bottom: 2px white solid;
        color:grey;
    }
    .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
        border-bottom: 2px {$conf['owner_color']} solid;
        color:{$conf['owner_color']};
    }
    </style>
    <div style="margin:0px;background-color: white">
        <div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="height:40px">
            <div id="all_item" class="mui-scroll">
                {if $conf['pin_mode_on'] == '1'}
                <a class="mui-control-item mui-active" href="javascript:void(0)">
                    {$conf['pin_mode_name']}
                </a>
                {/if}
                {if $conf['fast_mode_on'] == '1'}
                <a class="mui-control-item" href="javascript:jump_out('{php echo $this->createMobileurl('owner_fast')}')">
                    {$conf['fast_mode_name']}
                </a>
                {/if}
                {if $conf['charter_mode_on'] == '1'}
                <a class="mui-control-item" href="javascript:jump_out('{php echo $this->createMobileurl('owner_charter')}')">
                    {$conf['charter_mode_name']}
                </a>
                {/if}
                {if $conf['cargo_mode_on'] == '1'}
                <a class="mui-control-item" href="javascript:jump_out('{php echo $this->createMobileurl('owner_cargo')}')">
                    {$conf['cargo_mode_name']}
                </a>
                {/if}
                {if $conf['bus_mode_on'] == '1'}
                <a class="mui-control-item" href="javascript:jump_out('{php echo $this->createMobileurl('owner_bus')}')">
                    {$conf['bus_mode_name']}
                </a>
                {/if}
                {loop $menu $index $item}
                    <a class="mui-control-item" href="javascript:jump_out('{$item['url']}')">
                        {$item['customer_name']}
                    </a>
                {/loop}
            </div>
        </div>
    </div>
    <script>
        mui('.mui-scroll-wrapper').scroll({
            deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
        });
        function jump_out(url) {
            location.href=url;
        }
    </script>
    {/if}
    <div id="travel_release_panel" style="position:fixed;bottom:0px;width:100%;z-index:999">
        <div id="release_btn" style="width:50px;height:90px;padding:5px 0px 5px 5px;background-color: #F3F3F3" onclick="release_new_pin()">
            <div style="height:80px;line-height: 80px;text-align: center;background-color: {$conf['owner_color']};color:white">
                发布
            </div>
        </div>
        <div id="release_panel" style="margin:-90px 0px 0px 50px;padding:5px;background-color: #F3F3F3">
            <div style="background-color: white;height:40px;border-top:1px #F3F3F3 solid">
                <div style="width:30px;height:40px;line-height: 40px;color:#3BBBA2;text-align: center">
                    <i class="fa fa-circle-o"></i>
                </div>
                <div style="height:40px;margin:-40px 0px 0px 30px">
                    {if $conf['pin_departure_station_mode']=='0'}
                    <input id="departure_station_release" style="width:100%;text-align: center;background-color: transparent;border:0px;border-radius: 0px;height:40px" placeholder="始发站" />
                    {else if $conf['pin_departure_station_mode']=='1'}
                    <input id="departure_station_release" style="width:100%;text-align: center;background-color: transparent;border:0px;border-radius: 0px;height:40px" readonly="true" onfocus="blur()" placeholder="选择出发站" onclick="sel_departure_station()" />
                    <script>
                        function sel_departure_station() {
                            $("#departure_station_panel").show();
                        }
                    </script>
                    {/if}
                </div>
            </div>
            <div style="background-color: white;height:40px;border-top:1px #F3F3F3 solid">
                <div style="width:30px;height:40px;line-height: 40px;color:#FB8641;text-align: center">
                    <i class="fa fa-circle"></i>
                </div>
                <div style="height:40px;margin:-40px 0px 0px 30px">
                    {if $conf['pin_terminal_station_mode']=='0'}
                    <input id="terminal_station_release" style="width:100%;text-align: center;background-color: transparent;border:0px;border-radius: 0px;height:40px" placeholder="终点站" />
                    {else if $conf['pin_terminal_station_mode']=='1'}
                    <input id="terminal_station_release" style="width:100%;text-align: center;background-color: transparent;border:0px;border-radius: 0px;height:40px" readonly="true" onfocus="blur()" placeholder="选择终点站" onclick="sel_terminal_station()" />
                    <script>
                        function sel_terminal_station() {
                            $("#terminal_station_panel").show();
                        }
                    </script>
                    {/if}
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="{$_W['siteroot']}app/resource/components/datepicker/mui.picker.all.css" />
    <script type="text/javascript" src="{$_W['siteroot']}app/resource/components/datepicker/mui.picker.all.js"></script>
    <script>
        var release_pin_mode = 0; //直接发布拼车还是接单时发布
        function release_new_pin() {
            $.post("{php echo $this->createMobileurl('get_pin_releasable')}",
                function(resp) {
                    resp = $.parseJSON(resp);
                    if(resp.message.errno == 0) {
                        release_pin_mode = 0;
                        $("#departure_station").val($("#departure_station_release").val());
                        $("#terminal_station").val($("#terminal_station_release").val());
                        $("#step_1").hide();
                        $("#step_3").show();
                    } else if (resp.message.errno == 1) {
                        mui.alert("您有未完成的出车，暂时不能发布出车！");
                    }
                }
            );
        }
        $('#departure_station_release').bind('input propertychange', function() {
            refresh();
        });
        $('#terminal_station_release').bind('input propertychange', function() {
            refresh();
        });
        function refresh() {
            $.post("{php echo $this->createMobileurl('owner_index',array('op'=>refresh))}",{
                    departure_station:$("#departure_station_release").val(),
                    terminal_station:$("#terminal_station_release").val(),
                    date:$("#date").val()
                },
                function(resp) {
                    resp = $.parseJSON(resp);
                    var data = resp.message.message;
                    console.log(data);
                    if(data == '') {
                        //mui.alert("无符合条件的拼车！");
                        $("#all_travel").html("");
                    } else {
                        $("#all_travel").html("");
                        for(var i=0; i<data.length; i++) {
                            var html = '<div id="travel_'+data[i].id+'" class="pin">'+
                                '<div style="text-align: center;width: 240px;margin:0px auto">'+data[i].departure_time+'</div>'+
                                '<div style="width:240px;margin:-10px auto 0px auto">'+
                                    '<div style="width:80px;float:left;text-align: center">'+
                                        data[i].departure_station+
                                    '</div>'+
                                    '<div style="text-align: center;width:80px;float:left">'+
                                        '<img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/arrow.png" height="auto" width="80px" />'+
                                    '</div>'+
                                    '<div style="width:80px;float:left;text-align: center">'+
                                        data[i].terminal_station+
                                    '</div>'+
                                '</div>'+
                                '<div style="clear:both;border-top: 1px #EFEFEF solid"></div>'+
                                '<div class="address">'+
                                    '<div style="width:40px;height:30px;text-align: center">'+
                                        '<img src="'+data[i].headimgurl+'" onerror="this.src=\'{$_W['siteroot']}addons/navlange_pinche/template/style/img/default_head_img.png\'" width="30px" height="30px" style="border-radius: 15px" />'+
                                    '</div>'+
                                    '<div style="height:30px;line-height: 30px;margin:-30px 150px 0px 40px;white-space: nowrap;text-overflow:ellipsis;overflow:hidden;">';
                                    if(data[i].nickname  == '' || data[i].nickname == null) {
                                        html += '乘客';
                                    } else {
                                        html += data[i].nickname;
                                    }
                                    html += '</div>'+
                                    '<div style="height:30px;margin:-30px 0px 0px auto;width:150px;line-height: 30px">'+
                                        '发布：'+data[i].release_time+
                                    '</div>'+
                                '</div>'+
                                '<div class="address">'+
                                    '登车地点：'+data[i].boarding_place+
                                '</div>'+
                                '<div style="border-top: 1px #EFEFEF solid"></div>'+
                                '<div style="width:200px;margin:10px auto 0px auto;text-align:center">'+
                                    '<button type="button" class="mui-btn mui-btn-warning mui-btn-block" onclick="accept_travel('+data[i].id+',\''+data[i].departure_station+'\','+'\''+data[i].terminal_station+'\''+')" style="background-color: #54BCDE;border:0px">接单</button>'+
                                '</div>'+
                            '</div>';
                            $("#all_travel").append(html);
                        }
                    }
                }
            );
        }
    </script>
    {if count($travel_info) == 0}
        <div style="width:260px;margin:40px auto">
            <div style="width:90px;height:80px">
                <img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/empty_order.png" width="80px" height="80px" />
            </div>
            <div style="margin:-80px 0px 0px 90px;padding-top:30px">
                暂无乘客发布出行需求！
            </div>
        </div>
    {else}
        <div id="all_travel">
        {loop $travel_info $index $item}
            <div id="travel_{$item['id']}" class="pin">
                <div style="text-align: center;width: 240px;margin:0px auto"><?php echo date('m-d H:i',$item['departure_time']); ?></div>
                <div style="width:240px;margin:-10px auto 0px auto">
                    <div style="width:80px;float:left;text-align: center">
                        {$item['departure_station']}
                    </div>
                    <div style="text-align: center;width:80px;float:left">
                        <img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/arrow.png" height="auto" width="80px" />
                    </div>
                    <div style="width:80px;float:left;text-align: center">
                        {$item['terminal_station']}
                    </div>
                </div>
                <div style="clear:both;border-top: 1px #EFEFEF solid"></div>
                <div class="address">
                    <div style="width:40px;height:30px;text-align: center">
                        <img src="{$item['headimgurl']}" onerror="this.src='{$_W['siteroot']}addons/navlange_pinche/template/style/img/default_head_img.png'" width="30px" height="30px" style="border-radius: 15px" />
                    </div>
                    <div style="height:30px;line-height: 30px;margin:-30px 120px 0px 40px;white-space: nowrap;text-overflow:ellipsis;overflow:hidden;">
                        {if $item['nickname']==''}
                            乘客
                        {else}
                            {$item['nickname']}
                        {/if}
                        {if $conf['passenger_info_available_before_pin']=='0'}
                            {$item['mobile']}
                        {/if}
                    </div>
                    <div style="height:30px;margin:-30px 0px 0px auto;width:120px;line-height: 30px">
                        发布：{php echo date('d/m H:i',$item['release_time']);}
                    </div>
                </div>
                <div class="address">
                    登车地点：{$item['boarding_place']}
                </div>
                <div style="border-top: 1px #EFEFEF solid"></div>
                <div class="container" style="margin-top:5px">
                    <div class="row">
                        <div class="col-xs-6" style="line-height: 33px">
                            期望价格：<span style="color:{$conf['owner_color']}"><i class="fa fa-cny"></i>{$item['expected_price']}</span>
                        </div>
                        <div class="col-xs-6">
                            <button type="button" class="mui-btn mui-btn-warning mui-btn-block" onclick="accept_travel({$item['id']},'{$item['departure_station']}','{$item['terminal_station']}')" style="background-color: #54BCDE;border:0px">接单</button>
                        </div>
                    </div>
                </div>
            </div>
        {/loop}
        </div>
    {/if}
    <div style="height:100px"></div>
    <style>
    .nav_item {
        color:grey;
        text-align: center
    }
    .nav_item_active {
        color:#54BCDE;
    }
    </style>
</div>
<script>
var selected_travel = 0;
var selected_travel_departure = '';
var selected_travel_terminal = '';
function accept_travel(id,departure_station,terminal_station) {
    if('{php echo empty($owner) ? 1 : 0}' == '1') {
        alert("请在车主个人中心完善车主信息再接单！");
    } else {
        selected_travel = id;
        selected_travel_departure = departure_station;
        selected_travel_terminal = terminal_station;
        $("#step_1").hide();
        refresh_step_2();
    }
}
function refresh_step_2() {
    $.post("{php echo $this->createMobileurl('owner_index',array('op'=>'get_owner_pin'))}",function(resp) {
            resp = $.parseJSON(resp);
            var pin = resp.message.message;
            $("#owner_pin").html('');
            for(var i=0; i<pin.length; i++) {
                html = '<div class="pin" id="pin_'+pin[i].id+'" onclick="sel_pin('+pin[i].id+')">'+
                        '<div style="text-align: center;width: 240px;margin:0px auto">'+pin[i].departure_time+'</div>'+
                        '<div style="width:240px;margin:-10px auto 0px auto">'+
                            '<div style="width:80px;float:left;text-align: center">'+
                                    pin[i].departure_station+
                            '</div>'+
                            '<div style="text-align: center;width:80px;float:left">'+
                                '<img src="{$_W['siteroot']}addons/navlange_pinche/template/style/img/arrow.png" height="auto" width="80px" />'+
                            '</div>'+
                            '<div style="width:80px;float:left;text-align: center">'+
                                    pin[i].terminal_station+
                            '</div>'+
                        '</div>'+
                        '<div style="clear:both;border-top: 1px #EFEFEF solid"></div>'+
                        '<div class="address">'+
                            '可乘人数：'+pin[i].passenger_count+
                        '</div>'+
                    '</div>';
                $("#owner_pin").append(html);
            }
            $("#step_2").show();
        }
    );
}
var selected_pin = 0;
function sel_pin(id) {
    $("div[id^='pin_']").each(function(){
        $(this).removeClass('pin_active');
    })
    $("#pin_"+id).addClass('pin_active');
    selected_pin = id;
}
</script>
<style>
.pin_active {
    border:1px {$conf['owner_color']} solid;
}
</style>
<div id="step_2" style="display: none">
    <div style="padding:10px;background-color: white" onclick="release_pin()">
        <div style="height:20px;margin:0px 20px 0px 0px;line-height: 20px">
            发布新的拼车
        </div>
        <div style="margin:-20px 0px 0px auto;line-height: 20px;text-align: center;width:20px">
            <i class="fa fa-plus-square-o"></i>
        </div>
    </div>
    <div id="owner_pin">

    </div>
    <div class="container" style="margin-top:20px">
        <div class="row">
            <div class="col-xs-6">
                <button class="mui-btn mui-btn-block" onclick="cancel_pin()">取消</button>
            </div>
            <div class="col-xs-6">
                <button class="mui-btn mui-btn-block" style="background-color: {$conf['owner_color']};color:white" onclick="pin_confirm()">确认选择</button>
            </div>
        </div>
    </div>
</div>
<script>
function cancel_pin() {
    $("#step_2").hide();
    $("#step_1").show();
}
function release_pin() {
    $.post("{php echo $this->createMobileurl('get_pin_releasable')}",
        function(resp) {
            resp = $.parseJSON(resp);
            if(resp.message.errno == 0) {
                release_pin_mode = 1;
                $("#departure_station").val(selected_travel_departure);
                $("#terminal_station").val(selected_travel_terminal);
                $("#step_2").hide();
                $("#step_3").show();
            } else if (resp.message.errno == 1) {
                mui.alert("您有未完成的出车，暂时不能发布出车！");
            }
        }
    )
}
function pin_confirm() {
    if(selected_pin == 0) {
        mui.alert("请选择拼车！");
    } else {
        $.post("{php echo $this->createMobileurl('owner_index',array('op'=>'pin_submit'))}",{
                pin_id:selected_pin,
                travel_id:selected_travel
            },function(resp) {
                resp = $.parseJSON(resp);
                if(resp.message.errno == '0') {
                    mui.alert("接单成功！",function(){
                        $("#step_2").hide();
                        $("#step_1").show();
                        $("#travel_"+selected_travel).remove();
                    })
                } else if (resp.message.errno == '1') {
                    alert("拼车已满！");
                } else {
                    alert("拼车失败！");
                }
            }
        );
    }
}
</script>
<div id="step_3" style="padding-top:20px;background-color:white;display:none">
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                    车&nbsp;&#12288;&nbsp;辆
            </div>
            <div class="item_2_1">
                <input value="{$owner['car_color']} {$owner['car_number_1']}{$owner['car_number_2']}{$owner['car_number_3']} {$owner['car_series']}" style="height:20px;width:100%;border:0px;padding:0px 10px" readonly onfocus="blur()" />
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                出&nbsp;发&nbsp;站
            </div>
            <div class="item_2_1">
                {if $conf['pin_departure_station_mode']=='0'}
                <input type="text" id="departure_station" name="departure_station" value="{$latest_pin['departure_station']}" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入出发站" >
                {else if $conf['pin_departure_station_mode']=='1'}
                <input type="text" id="departure_station" name="departure_station" value="{$latest_pin['departure_station']}" style="height:20px;width:100%;border:0px;padding:0px 10px" readonly="true" onfocus="blur()" placeholder="请选择出发站" onclick="sel_departure_station()" >
                <script>
                    function sel_departure_station() {
                        $("#departure_station_panel").show();
                    }
                </script>
                {/if}
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                终&nbsp;点&nbsp;站
            </div>
            <div class="item_2_1">
                {if $conf['pin_terminal_station_mode']=='0'}
                <input type="text" id="terminal_station" name="terminal_station" value="{$latest_pin['terminal_station']}" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入终点站" >
                {else if $conf['pin_terminal_station_mode']=='1'}
                <input type="text" id="terminal_station" name="terminal_station" value="{$latest_pin['terminal_station']}" style="height:20px;width:100%;border:0px;padding:0px 10px" readonly="true" onfocus="blur()" placeholder="请选择终点站" onclick="sel_terminal_station()" >
                <script>
                    function sel_terminal_station() {
                        $("#terminal_station_panel").show();
                    }
                </script>
                {/if}
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                人&nbsp;&#12288;&nbsp;数
            </div>
            <div class="item_2_1">
                <input id="passenger_count" name="passenger_count" value="1" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入拼车人数" >
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                发车时间
            </div>
            <div class="item_2_1">
                <input id="departure_time" name="departure_time" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请选择发车时间" readonly>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="{$_W['siteroot']}app/resource/components/datepicker/mui.picker.all.css" />
    <script type="text/javascript" src="{$_W['siteroot']}app/resource/components/datepicker/mui.picker.all.js"></script>
    <script>
        $("input[name='departure_time']").click(function(){
            var today = new Date();
            var year = today.getFullYear();
        　　var dtPicker = new mui.DtPicker({
                beginYear: year,//设置开始日期 
                endYear: year+1,//设置结束日期
                beginMonth:4,
                endMonth:4
            }); 
            dtPicker.show(function (selectItems) { 
                var str_time = selectItems.y.value+"/"+selectItems.m.value+"/"+selectItems.d.value+" "+selectItems.h.value+":"+selectItems.i.value;
                var sel_date = new Date(str_time);
                var timestamp = Date.parse(sel_date);
                var now = Date.parse(today);
                if(timestamp < now) {
                    mui.alert("出行时间已过，请重新选择！");
                } else if (timestamp > ({$conf['max_day_to_release']}*24*60*60*1000+now)) {
                    mui.alert("只能发布{$conf['max_day_to_release']}天以内的拼车，谢谢您的配合！");
                } else {
                    $("input[name='departure_time']").val(str_time);
                }
            })
        })
    </script>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                登车地点
            </div>
            <div class="item_2_2">
                <input id="boarding_place" name="boarding_place" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入登车地点" >
                <input id="lng" name="lng" type="hidden" />
                <input id="lat" name="lat" type="hidden" />
            </div>
            <div class="item_3_1" onclick="sel_boarding_place()">
                地图标注&nbsp;<i class="fa fa-map-marker"></i>
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                模&nbsp;&#12288;&nbsp;式
            </div>
            <div class="item_2_1">
                <select id="mode" name="mode" style="height:20px;width:100%;border:0px;padding:0px 10px">
                    <option value="请选择">请选择</option>
                    <option value="全程高速">全程高速</option>
                    <option value="高速优先">高速优先</option>
                    <option value="不走高速">不走高速</option>
                    <option value="少收费">少收费</option>
                </select>
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                线&nbsp;&#12288;&nbsp;路
            </div>
            <div class="item_2_1">
                {if $conf['pin_line_mode']=='0'}
                <input id="line" name="line" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入线路" >
                {else if $conf['pin_line_mode']=='1'}
                <input id="line" name="line" style="height:20px;width:100%;border:0px;padding:0px 10px" readonly="true" onfocus="blur()" placeholder="请选择线路" onclick="sel_line()" >
                <script>
                    function sel_line() {
                        if($("#departure_station").val() == '') {
                            alert("请选择始发站！");
                        } else if ($("#terminal_station").val()== '') {
                            alert("请选择终点站！");
                        }
                        $.post("{php echo $this->createMobileurl('get_line')}",{
                                departure_station:selected_departure_station,
                                terminal_station:selected_terminal_station,
                            },function(resp) {
                                resp = $.parseJSON(resp);
                                if(resp.message.errno == 0) {
                                    var line = resp.message.message;
                                    var html = '';
                                    if(line == false) {
                                        html += '<div style="text-align:center;width:100%;margin-top:50px;font-weight:bold">无支持的线路！</div>';
                                    } else {
                                        for(var i=0; i<line.length; i++) {
                                            html += '<div style="margin:5px 10px;border:1px grey solid;border-radius: 3px;padding:5px" onclick="sel_line_confirm(\''+line[i].name+'\','+line[i].price+')">'+
                                                '<span class="mui-icon mui-icon-checkmarkempty"></span>&nbsp;'+line[i].name+'&#12288;<span style="color:red"><i class="fa fa-cny"></i>'+line[i].price+'</span>'+
                                            '</div>';
                                        }
                                    }
                                    $("#all_line").html(html);
                                }
                            }
                        );
                        $("#line_panel").show();
                    }
                </script>
                {/if}
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                价&nbsp;&#12288;&nbsp;格
            </div>
            <div class="item_2_1">
                <input id="price" name="price" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入拼车价格" >
            </div>
        </div>
    </div>
    <div style="height:10px"></div>
    <div class="item">
        <div class="item_content">
            <div class="item_1">
                备&nbsp;&#12288;&nbsp;注
            </div>
            <div class="item_2_1">
                <input id="note" name="note" style="height:20px;width:100%;border:0px;padding:0px 10px" placeholder="请输入备注" >
            </div>
        </div>
    </div>
    <div style="margin:10px">
        <div class="container">
            <div class="row">
                <div class="col-xs-6">
                    <button class="mui-btn mui-btn-block" style="background-color: #a8a8a8;color:white;border:0px" onclick="cancel_submit()">取消</button>
                </div>
                <div class="col-xs-6">
                    <button class="mui-btn mui-btn-block" style="background-color: #54BCDE;color:white;border:0px" onclick="release_submit()">发布</button>
                </div>
            </div>
        </div>
    </div>
    <div style="height:50px"></div>
</div>
<script>
function release_submit() {
    if($("#departure_station").val() == '') {
        alert("请输入出发站！");
        $("#departure_station").focus();
    } else if($("#terminal_station").val() == '') {
        alert("请输入目的站！");
        $("#terminal_station").focus();
    } else if($("#passenger_count").val() == '') {
        alert("请输入可乘人数！");
        $("#passenger_count").focus();
    } else if($("#departure_time").val() == '') {
        alert("请选择出发时间！");
        $("#departure_time").focus();
    } else if($("#boarding_place").val() == '') {
        alert("请输入登车地点！");
        $("#boarding_place").focus();
    } else if($("#mode").val() == '请选择') {
        alert("请选择行车模式！");
        $("#mode").focus();
    } else {
        $.post("{php echo $this->createMobileurl('owner_index',array('op'=>'release_submit'))}",{
                departure_station: $("#departure_station").val(),
                terminal_station: $("#terminal_station").val(),
                passenger_count: $("#passenger_count").val(),
                departure_time: $("#departure_time").val(),
                boarding_place: $("#boarding_place").val(),
                lng:$("#lng").val(),
                lat:$("#lat").val(),
                mode: $("#mode").val(),
                price: $("#price").val(),
                line: $("#line").val(),
                note: $("#note").val(),
            },function(resp) {
                resp = $.parseJSON(resp);
                if(resp.message.errno == '0') {
                    $("#step_3").hide();
                    if(release_pin_mode == 1) {
                        refresh_step_2();
                    } else {
                        $("#step_1").show();
                    }
                }
            }
        );
    }
}
function cancel_submit() {
    $("#step_3").hide();
    if(release_pin_mode == 1) {
        refresh_step_2();
    } else {
        $("#step_1").show();
    }
}
</script>

<script>
    function change_city() {
        $("#step_1").hide();
        $("#city_panel").show();
    }
</script>
<style>
    .city_item {
        height:40px;
        line-height: 40px;
        background-color: white;
        padding:0px 10px;
    }
</style>
<div id="city_panel" style="background-color: {$conf['bg_color']};display:none">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-icon mui-icon-left-nav mui-pull-left" href="javascript:cancel_city_select()"></a>
        <h1 class="mui-title">选择城市</h1>
    </header>
    <script type="text/javascript">
        function cancel_city_select() {
            $("#city_panel").hide();
            $("#step_1").show();
        }
    </script>
    <div style="position: fixed;top:0px;right:0px;width:30px;height:100%;text-align: center;background:rgba(0, 0, 0, 0.1)!important;filter:Alpha(opacity=10); background:#000;z-index: 2;padding-top: 100px;color:grey">
        {loop $all_city $index $item}
            <div>{$item['alphabetical_index']}</div>
        {/loop}
    </div>
    <div style="height:60px"></div>
    <div style="height:40px;line-height: 40px;background-color: white;padding:0px 10px">
        <span style="color:grey">当前城市：</span>
        <span id="step_2_cur_city">{php echo $this->rtrim_cn($_SESSION['city'],'市');}</span>
    </div>
    {loop $all_city $index $item}
        <div style="height:40px;line-height: 40px;padding:0px 10px;color:grey">{$item['alphabetical_index']}</div>
        {loop $item['city'] $i $city}
            <div class="city_item" onclick="sel_city({$city['id']},'{$city['city']}')">
                {php echo $this->rtrim_cn($city['city'],'市');}
            </div>
        {/loop}
    {/loop}
</div>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=gCF3WxqfpdvaRxciR9m1Nm7lbgEwXrky"></script>
<script src="{$_W['siteroot']}addons/navlange_pinche/template/style/js/location_convertor.js"></script>
<script>
var center;
var map;
var marker;// 创建标注
wx.config(jssdkconfig);
wx.ready(function(){
    wx.getLocation({
        type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
        success: function (res) {
            $("#map_container").css('width',window.screen.width);
            $("#map_container").css('height',window.screen.height);
            var cur_latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
            var cur_longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
            $("#lng").val(cur_longitude);
            $("#lat").val(cur_latitude);
            var bd_point = gcj02tobd09(cur_longitude,cur_latitude);
            var gpsPoint = new BMap.Point(bd_point[0], bd_point[1]);
            get_position(gpsPoint);
        }
    });     
});
function get_position(point) {
    center = point;
    var geoc = new BMap.Geocoder();
    geoc.getLocation(point, function(rs){
        var addComp = rs.addressComponents;
        $("#release_boarding_place").val(addComp.street + addComp.streetNumber);
        $("#boarding_place").val(addComp.street + addComp.streetNumber);
    })
}
function sel_boarding_place() {
    $("#step_3").hide();
    $("#district_panel").show();
    map = new BMap.Map("map_container");
    marker = new BMap.Marker(center);// 创建标注
    map.centerAndZoom(center, 13);
    map.addOverlay(marker);             // 将标注添加到地图中
    marker.enableDragging();
    marker.addEventListener("dragend",function(e){
        center = new BMap.Point(e.point.lng,e.point.lat);
        var geoc = new BMap.Geocoder();
        geoc.getLocation(center, function(rs){
            var addComp = rs.addressComponents;
            $("#boarding_place").val(addComp.street + addComp.streetNumber);
            var gcj_point = bd09togcj02(e.point.lng,e.point.lat);
            $("#lng").val(gcj_point[0]);
            $("#lat").val(gcj_point[1]);
        });    
    })
}
function theLocation(){
    if($("#search_address").val() == "") {
        alert("请输入要搜索的地名！");
    } else {  
        var local = new BMap.LocalSearch(map, {
            onSearchComplete:function(res) {
                center = res.getPoi(0).point;
                var gcj_point = bd09togcj02(center.lng,center.lat);
                $("#lng").val(gcj_point[0]);
                $("#lat").val(gcj_point[1]);
                map.centerAndZoom(res.getPoi(0).point, 13);
                marker.setPosition(res.getPoi(0).point);
                var geoc = new BMap.Geocoder();
                geoc.getLocation(res.getPoi(0).point, function(rs){
                    var addComp = rs.addressComponents;
                    $("#boarding_place").val(addComp.street + addComp.streetNumber);
                })
            }
        });
        local.search($("#search_address").val());
    }
}

$(function(){
    var win_height = document.body.clientHeight;
    $("#city_panel").css('min-height',win_height);
})
function sel_city(id,city) {
    location.href="{php echo $this->createMobileurl('owner_index')}"+"&city="+id;
}
String.prototype.trim = function (char, type) {
    if (char) {
        if (type == 'left') {
            return this.replace(new RegExp('^\\'+char+'+', 'g'), '');
        } else if (type == 'right') {
            return this.replace(new RegExp('\\'+char+'+$', 'g'), '');
        }
        return this.replace(new RegExp('^\\'+char+'+|\\'+char+'+$', 'g'), '');
    }
    return this.replace(/^\s+|\s+$/g, '');
};
</script>

<div id="district_panel" style="width:100%;height:100%;display:none;z-index: 999;position: fixed;">
    <div id="map_container" style="position: fixed;width:100%;height:100%;top:0px">

    </div>
    <div style="position: fixed;top:10px;width:100%;">
        <div style="margin:0px 10px">
            <div class="input-group">
                <input id="search_address" class="form-control" placeholder="请输入地址">
                <span class="input-group-addon" onclick="theLocation()"><i class="fa fa-search"></i></span>
            </div>
        </div>
    </div>
    <div style="position: fixed;bottom:0px;width:100%;text-align: center;background:rgba(0, 0, 0, 0.6)!important;filter:Alpha(opacity=60); background:#000;padding:5px;color:white">
        <div class="container">
            <div class="row">
                <div class="col-xs-8" style="text-align: left;line-height: 33px">
                    精确地图标注有助于司机找到您！
                </div>
                <div class="col-xs-4" style="text-align: right">
                    <button class="mui-btn mui-btn-warning" onclick="sel_address_confirm()">选取</button>
                </div>
            </div>              
        </div>
    </div>
</div>
<script>
    function sel_address_confirm() {
        $('#district_panel').hide();
        $("#step_3").show();
        tankuang(200,'地图标注成功！');
    }
</script>

{if $need_check == '1'}
<div id="mask" style="position: fixed;top:0px;width:100%;height:100%;background:rgba(0, 0, 0, 0.6)!important;filter:Alpha(opacity=60); background:#000;z-index:999;">
    <div style="margin-top:30%;width:100%;color:white">
        <div style="text-align: center;font-size:18px">
            <i class="fa fa-info-circle"></i>&nbsp;尚未认证车主不能发布拼车！
        </div>
        <div style="text-align: center;margin-top:20px">
            <button class="mui-btn mui-btn-outlined" style="border-color:white;color:white;font-size:18px" onclick="location.href='{php echo $this->createMobileurl('index')}'">返回</button>
            <button class="mui-btn mui-btn-outlined" style="border-color:white;color:white;font-size:18px" onclick="location.href='{php echo $this->createMobileurl('owner_info')}'">去认证</button>
        </div>
    </div>
</div>
{else if $conf['release_need_license']=='1'&& $owner['credit_score']<$conf['pin_release_need_credit_score']}
<div id="mask" style="position: fixed;top:0px;width:100%;height:100%;background:rgba(0, 0, 0, 0.6)!important;filter:Alpha(opacity=60); background:#000;z-index:999;">
    <div style="margin-top:30%;width:100%;color:white">
        <div style="text-align: center;font-size:18px">
            <i class="fa fa-info-circle"></i>&nbsp;当前信誉值低于发布所需最低信誉值，不能发布拼车！
        </div>
        <div style="text-align: center;margin-top:20px">
            <button class="mui-btn mui-btn-outlined" style="border-color:white;color:white;font-size:18px" onclick="location.href='{php echo $this->createMobileurl('index')}'">返回</button>
        </div>
    </div>
</div>
{/if}

{if $conf['pin_departure_station_mode']=='1'}
<div id="departure_station_panel" style="display:none;z-index:999;position: fixed;top:0px;min-height: 100%;width:100%;background-color: white">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-icon mui-icon-arrowleft" href="javascript:cancel_departure_station_sel()"></a>
        <h1 class="mui-title">选择出发站</h1>
    </header>
    <div style="height:50px"></div>
    <div>
        {loop $departure_station $index $item}
            <div style="margin:5px 10px;border:1px grey solid;border-radius: 3px;padding:5px" onclick="sel_departure_station_confirm({$item['id']},'{$item['name']}')">
                <span class="mui-icon mui-icon-checkmarkempty"></span>&nbsp;{$item['name']}
            </div>
        {/loop}
    </div>
</div>
<script>
var selected_departure_station = 0;
function cancel_departure_station_sel() {
    $("#departure_station_panel").hide();
}
function sel_departure_station_confirm(id,name) {
    selected_departure_station = id;
    $("#departure_station").val(name);
    $("#departure_station_release").val(name);
    $("#departure_station_panel").hide();
}
</script>
{/if}

{if $conf['pin_terminal_station_mode']=='1'}
<div id="terminal_station_panel" style="display:none;z-index:999;position: fixed;top:0px;min-height: 100%;width:100%;background-color: white">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-icon mui-icon-arrowleft" href="javascript:cancel_terminal_station_sel()"></a>
        <h1 class="mui-title">选择终点站</h1>
    </header>
    <div style="height:50px"></div>
    <div>
        {loop $terminal_station $index $item}
            <div style="margin:5px 10px;border:1px grey solid;border-radius: 3px;padding:5px" onclick="sel_terminal_station_confirm({$item['id']},'{$item['name']}')">
                <span class="mui-icon mui-icon-checkmarkempty"></span>&nbsp;{$item['name']}
            </div>
        {/loop}
    </div>
</div>
<script>
var selected_terminal_station = 0;
function cancel_terminal_station_sel() {
    $("#terminal_station_panel").hide();
}
function sel_terminal_station_confirm(id,name) {
    selected_terminal_station = id;
    $("#terminal_station").val(name);
    $("#terminal_station_release").val(name);
    $("#terminal_station_panel").hide();
}
</script>
{/if}

{if $conf['pin_line_mode']=='1'}
<div id="line_panel" style="display:none;z-index:999;position: fixed;top:0px;min-height: 100%;width:100%;background-color: white">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-icon mui-icon-arrowleft" href="javascript:cancel_line_sel()"></a>
        <h1 class="mui-title">选择线路</h1>
    </header>
    <div style="height:50px"></div>
    <div id="all_line">
        
    </div>
</div>
<script>
function cancel_line_sel() {
    $("#line_panel").hide();
}
function sel_line_confirm(name,price) {
    $("#price").val(price);
    $("#line").val(name);
    $("#line_panel").hide();
}
</script>
{/if}
<script>
function tankuang(pWidth,content) {    
    $("#msg").remove();
    var html ='<div id="msg" style="position:fixed;bottom:30px;width:100%;height:30px;line-height:30px;margin-top:-15px;z-index:1000"><p style="background:#000;opacity:0.8;width:'+ pWidth +'px;color:#fff;text-align:center;padding:10px 10px;margin:0 auto;font-size:12px;border-radius:4px;">'+ content +'</p></div>'
    $("body").append(html);
    var t=setTimeout(next,2000);
    function next() {
        $("#msg").remove();
    }
}
</script>